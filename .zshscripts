# awerebea's personal zsh scripts and functions

# Detect and setup current environment (home/docker)
if [[ `uname -n` == "pc-home" && `echo ${WSL_DISTRO_NAME}` == "Ubuntu" ]]; then
  # Home Ubuntu in WSL (Windows)
  export ZSH="$HOME/.oh-my-zsh"
  export DOCKER_CMD_FOR_ALIAS="sudo docker"
  export GIT_DOTFILES="$HOME/Github/dotfiles"
  export GIT_WORKSPACE="$HOME/Github/workspace"
  alias o='a -e xdg-open >/dev/null 2>&1' # quick opening files with xdg-open
  alias open='xdg-open >/dev/null 2>&1' # quick opening files with xdg-open
  # set coursor like blinking block
  printf '\e[1 q'

elif [[ `uname -n` == "pc-home" && `uname` == "Linux" ]]; then
  # Manjaro @ home-pc
  export ZSH="$HOME/.oh-my-zsh"
  export DOCKER_CMD_FOR_ALIAS="sudo docker"
  export GIT_DOTFILES="/run/media/andrei/awerebea/Github/dotfiles"
  export GIT_WORKSPACE="/run/media/andrei/awerebea/Github/workspace"
  export PATH="$PATH:$HOME/.local/share/gem/ruby/3.0.0/bin"
  alias o='a -e xdg-open >/dev/null 2>&1' # quick opening files with xdg-open
  alias open='xdg-open >/dev/null 2>&1' # quick opening files with xdg-open
  alias tmpunlink="sudo rm -f /var/tmp && sleep 1 && sudo mkdir /var/tmp"
  alias tmprelink="sudo rm -rf /var/tmp && sleep 1 && sudo ln -s /run/media/andrei/Data/Temp-lin/var/tmp/ /var/tmp"
  # The 1st command is to map CAPSLOCK to ESC whereas the 2nd one takes care of CTRL pressed with other keys
  # setxkbmap -option 'caps:ctrl_modifier'
  # xcape -e 'Caps_Lock=Escape;Control_L=Escape;Control_R=Escape'
  # set coursor like blinking block
  printf '\e[1 q'

elif [[ `uname -n` == "pc-home" && `uname` == "Darwin" ]]; then
  # Home macOS
  export ZSH="/Users/andrei/.oh-my-zsh"
  export DOCKER_CMD_FOR_ALIAS="docker"
  export GIT_DOTFILES="/Volumes/awerebea/Github/dotfiles"
  export GIT_WORKSPACE="/Volumes/awerebea/Github/workspace"
  alias o='a -e open' # quick opening files with open
  alias sudo='sudo '
  alias sudoedit="sudo vim"
  export PATH="$PATH:/Users/andrei/Library/Python/3.7/bin"
  export PATH="$PATH:/Users/andrei/.local/bin"
  if [ -x '/Users/andrei/.local/bin/vim' ]; then
    alias vim='/Users/andrei/.local/bin/vim'
    export EDITOR='/Users/andrei/.local/bin/vim'
  fi
  # set coursor like blinking block
  printf '\e[1 q'

elif [[ `uname -n` == "laptop-dell" && `uname` == "Linux" ]]; then
  # Work laptop
  export ZSH="$HOME/.oh-my-zsh"
  export DOCKER_CMD_FOR_ALIAS="docker"
  export GIT_DOTFILES="$HOME/Documents/Github/dotfiles"
  export GIT_WORKSPACE="$HOME/Documents/Github/workspace"
  export PATH="$PATH:/var/lib/gems/2.7.0"
  export PATH="$PATH:/opt/mssql-tools/bin"
  alias o='a -e xdg-open >/dev/null 2>&1' # quick opening files with xdg-open
  alias open='xdg-open >/dev/null 2>&1' # quick opening files with xdg-open
  # set coursor like blinking block
  printf '\e[1 q'
  # Fix history-substring-search plugin behaviour in Tmux
  bindkey "$terminfo[kcuu1]" history-substring-search-up
  bindkey "$terminfo[kcud1]" history-substring-search-down
  # The 1st command is to map CAPSLOCK to ESC whereas the 2nd one takes care of CTRL pressed with other keys
  # setxkbmap -option 'caps:ctrl_modifier'
  # xcape -e 'Caps_Lock=Escape;Control_L=Escape;Control_R=Escape'

elif [[ `uname -n` == "laptop-acer" && `uname` == "Linux" ]]; then
  # laptop-acer
  export ZSH="$HOME/.oh-my-zsh"
  export DOCKER_CMD_FOR_ALIAS="docker"
  export GIT_DOTFILES="$HOME/Documents/Github/dotfiles"
  export GIT_WORKSPACE="$HOME/Documents/Github/workspace"
  export PATH="$PATH:/var/lib/gems/2.7.0"
  export PATH="$PATH:/opt/mssql-tools/bin"
  alias o='a -e xdg-open >/dev/null 2>&1' # quick opening files with xdg-open
  alias open='xdg-open >/dev/null 2>&1' # quick opening files with xdg-open
  # set coursor like blinking block
  printf '\e[1 q'
  # Fix history-substring-search plugin behaviour in Tmux
  bindkey "$terminfo[kcuu1]" history-substring-search-up
  bindkey "$terminfo[kcud1]" history-substring-search-down
  # The 1st command is to map CAPSLOCK to ESC whereas the 2nd one takes care of CTRL pressed with other keys
  # setxkbmap -option 'caps:ctrl_modifier'
  # xcape -e 'Caps_Lock=Escape;Control_L=Escape;Control_R=Escape'

else
  export ZSH="$HOME/.oh-my-zsh"
  export GIT_DOTFILES="$HOME/Github/dotfiles"
  export GIT_WORKSPACE="$HOME/Github/workspace"
  alias o='a -e xdg-open >/dev/null 2>&1' # quick opening files with xdg-open
  alias open='xdg-open >/dev/null 2>&1' # quick opening files with xdg-open
fi

# Fix oh-my-zsh history-sync plugin
function zhistsyncplugfix() {
  sed -i "s/add\ \*/\"\$ZSH_HISTORY_FILE_ENC_NAME\"/" $ZSH/custom/plugins/history-sync/history-sync.plugin.zsh
  sed -i "s/GIT_COMMIT_MSG=\"latest \$(date)\"/GIT_COMMIT_MSG=\"Sync\ zsh\ history\"/" $ZSH/custom/plugins/history-sync/history-sync.plugin.zsh
  export GIT_COMMIT_MSG="Sync zsh history"
}

# fasd history sync via GitHub
function fhistsync() {
  echo "\e[1;33mNeed to pull before sync? (y/N)\e[0m"
  while true; do
    read -r input
    case $input in
        [yY][eE][sS]|[yY])
     git -C ${GIT_WORKSPACE} pull; break;;
        [nN][oO]|[nN])
     echo "\e[1;33mLocal file used\e[0m"; break;;
        *)
     echo "\e[1;33mIncorrect input. Need to pool? Answer: \e[1;32mYes\e[1;33m/\e[1;31mNo \e[1;32my\e[1;33m/\e[1;31mn \e[1;32mY\e[1;33m/\e[1;31mN\e[0m";;
    esac
  done
  cat ${HOME}/.fasd >> ${GIT_WORKSPACE}/.fasd
  cat ${GIT_WORKSPACE}/.fasd | sort -t $'\|' -rk2 | awk -F"[|]" '!a[$1]++' > ${GIT_WORKSPACE}/.fasd_
  rm -f ${GIT_WORKSPACE}/.fasd ${HOME}/.fasd
  mv ${GIT_WORKSPACE}/.fasd_ ${GIT_WORKSPACE}/.fasd
  cp -rf ${GIT_WORKSPACE}/.fasd ${HOME}/.fasd
  git -C ${GIT_WORKSPACE} add .fasd
  git -C ${GIT_WORKSPACE} commit -m "Sync fasd history"
  echo "\e[1;33mfasd synced history commited, need to push? (y/N)\e[0m"
  while true; do
    read -r input
    case $input in
        [yY][eE][sS]|[yY])
     git -C ${GIT_WORKSPACE} push origin; break;;
        [nN][oO]|[nN])
     break;;
        *)
     echo "\e[1;33mIncorrect input. Need to push? Answer: \e[1;32mYes\e[1;33m/\e[1;31mNo \e[1;32my\e[1;33m/\e[1;31mn \e[1;32mY\e[1;33m/\e[1;31mN\e[0m";;
    esac
  done
}

# "Forget" last N commands from history
# Put a space at the start of a command to make sure it doesn't get added to the history.
alias frgt=' my_remove_last_history_entry' # Added a space in 'my_remove_last_history_entry' so that zsh forgets the 'forget' command :).
my_remove_last_history_entry() {
    # This sub-function checks if the argument passed is a number.
    # Thanks to @yabt on stackoverflow for this :).
    is_int() ( return $(test "$@" -eq "$@" > /dev/null 2>&1); )
    # Set history file's location
    history_file="${ZSH_HISTORY_FILE}"
    history_temp_file="${history_file}.tmp"
    # Check if the user passed a number, so we can delete N lines from history.
    if [ $# -eq 0 ]; then
        # No arguments supplied, so set to one.
        lines_to_remove=1
    else
        # An argument passed. Check if it's a number.
        if $(is_int "${1}"); then
            lines_to_remove="$1"
        else
            echo "Unknown argument passed. Exiting..."
            return
        fi
    fi
    # fc -W # write current shell's history to the history file.
    sed "$(($(wc -l < $history_file)-$lines_to_remove + 1)),\$d" $history_file > $history_temp_file 2>/dev/null
    mv "$history_temp_file" "$history_file"
    fc -R # read history file.
}

# create git hooks for ctags tags update
function githooksctags() {
  touch -a .git/hooks/post-checkout
  grep -qxF '#!/bin/bash' .git/hooks/post-checkout || echo "#!/bin/bash" >> .git/hooks/post-checkout
  grep -qxF 'ctags -R --fields=+l --tag-relative=yes --exclude=.git --exclude=.gitignore --exclude=@.gitignore --exclude=@.ctagsignore -f .git/tags 2>/dev/null' .git/hooks/post-checkout || echo "ctags -R --fields=+l --tag-relative=yes --exclude=.git --exclude=.gitignore --exclude=@.gitignore --exclude=@.ctagsignore -f .git/tags 2>/dev/null" >> .git/hooks/post-checkout
  chmod +x .git/hooks/post-checkout
  touch -a .git/hooks/post-commit
  grep -qxF '#!/bin/bash' .git/hooks/post-commit || echo "#!/bin/bash" >> .git/hooks/post-commit
  grep -qxF 'ctags -R --fields=+l --tag-relative=yes --exclude=.git --exclude=.gitignore --exclude=@.gitignore --exclude=@.ctagsignore -f .git/tags 2>/dev/null' .git/hooks/post-commit || echo "ctags -R --fields=+l --tag-relative=yes --exclude=.git --exclude=.gitignore --exclude=@.gitignore --exclude=@.ctagsignore -f .git/tags 2>/dev/null" >> .git/hooks/post-commit
  chmod +x .git/hooks/post-commit
}

## bash and zsh only!
# functions to cd to the next or previous sibling directory, in glob order

prev () {
  # default to current directory if no previous
  local prevdir="./"
  local cwd=${PWD##*/}
  if [[ -z $cwd ]]; then
    # $PWD must be /
    echo 'No previous directory.' >&2
    return 1
  fi
  for x in ../*/; do
    if [[ ${x#../} == ${cwd}/ ]]; then
      # found cwd
      if [[ $prevdir == ./ ]]; then
        echo 'No previous directory.' >&2
        return 1
      fi
      cd "$prevdir"
      return
    fi
    if [[ -d $x ]]; then
      prevdir=$x
    fi
  done
  # Should never get here.
  echo 'Directory not changed.' >&2
  return 1
}

next () {
  local foundcwd=
  local cwd=${PWD##*/}
  if [[ -z $cwd ]]; then
    # $PWD must be /
    echo 'No next directory.' >&2
    return 1
  fi
  for x in ../*/; do
    if [[ -n $foundcwd ]]; then
      if [[ -d $x ]]; then
        cd "$x"
        return
      fi
    elif [[ ${x#../} == ${cwd}/ ]]; then
      foundcwd=1
    fi
  done
  echo 'No next directory.' >&2
  return 1
}

alias ghtkn="gpg $GIT_WORKSPACE/github_token.gpg; source $GIT_WORKSPACE/github_token; rm -f $GIT_WORKSPACE/github_token"

dkremote() {
  export DOCKER_HOST="tcp://10.10.15.162:2376"
  export DOCKER_TLS_VERIFY=1
}

dklocal() {
  unset DOCKER_HOST
  unset DOCKER_TLS_VERIFY
}

# Source broot shell script
BR_SCRIPT="$HOME/.config/broot/launcher/bash/br"
if [ -f "$BR_SCRIPT" ]; then
  source "$BR_SCRIPT"
fi
