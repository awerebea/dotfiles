#!/usr/bin/env bash
# Cross-platform secure secret manager
# Supports:
#   - macOS Keychain (security)
#   - Linux Secret Service (secret-tool)
#   - pass (fallback)
# Features:
#   set/get/delete/copy
# Usage:
#   keychain-secret set <service> [account]
#   keychain-secret get <service> [account]
#   keychain-secret delete <service> [account]
#   keychain-secret copy <service> [account]

set -euo pipefail

usage() {
    echo "Usage:"
    echo "  $0 set <service> [account]"
    echo "  $0 get <service> [account]"
    echo "  $0 delete <service> [account]"
    echo "  $0 copy <service> [account]"
    exit 1
}

[[ $# -lt 2 ]] && usage

action="$1"
service="$2"
account="${3:-$USER}"

# --- Detect backend ---
detect_backend() {
    if command -v security >/dev/null 2>&1 && [[ "$OSTYPE" == "darwin"* ]]; then
        echo "macos"
    elif command -v secret-tool >/dev/null 2>&1; then
        echo "secret-tool"
    elif command -v pass >/dev/null 2>&1; then
        echo "pass"
    else
        echo "none"
    fi
}

backend=$(detect_backend)
[[ "$backend" == "none" ]] && {
    echo "‚ùå No supported secret backend found."
    exit 1
}

# --- Clipboard helper ---
copy_to_clipboard() {
    if [[ "$OSTYPE" == "darwin"* ]]; then
        pbcopy
    elif command -v xclip >/dev/null 2>&1; then
        xclip -selection clipboard
    elif command -v xsel >/dev/null 2>&1; then
        xsel --clipboard --input
    else
        echo "‚ö†Ô∏è Clipboard tool not found (install xclip or xsel)." >&2
        return 1
    fi
}

# --- Secret retrieval (used by get/copy) ---
fetch_secret() {
    case "$backend" in
    macos)
        security find-generic-password -a "$account" -s "$service" -w 2>/dev/null || return 1
        ;;
    secret-tool)
        secret-tool lookup service "$service" account "$account" 2>/dev/null || return 1
        ;;
    pass)
        pass show "$service/$account" 2>/dev/null || return 1
        ;;
    esac
}

# --- Command handlers ---
case "$action" in
set)
    read -s -p "Enter secret for '$service': " secret
    echo
    case "$backend" in
    macos)
        security delete-generic-password -a "$account" -s "$service" >/dev/null 2>&1 || true
        security add-generic-password -a "$account" -s "$service" -w "$secret" >/dev/null
        ;;
    secret-tool)
        secret-tool store --label="$service" service "$service" account "$account" <<<"$secret"
        ;;
    pass)
        pass insert -m "$service/$account" <<<"$secret"
        ;;
    esac
    echo "‚úÖ Stored secret for '$service' ($backend)"
    ;;

get)
    fetch_secret || {
        echo "‚ùå Secret not found for '$service'" >&2
        exit 1
    }
    ;;

copy)
    secret_val="$(fetch_secret)" || {
        echo "‚ùå Secret not found for '$service'" >&2
        exit 1
    }
    printf '%s' "$secret_val" | copy_to_clipboard && echo "üìã Copied secret for '$service' to clipboard"
    unset secret_val
    ;;

delete)
    case "$backend" in
    macos)
        security delete-generic-password -a "$account" -s "$service" >/dev/null 2>&1 &&
            echo "üóëÔ∏è Deleted secret for '$service'" || echo "‚ùå Secret not found for '$service'"
        ;;
    secret-tool)
        secret-tool clear service "$service" account "$account" >/dev/null 2>&1 &&
            echo "üóëÔ∏è Deleted secret for '$service'" || echo "‚ùå Secret not found for '$service'"
        ;;
    pass)
        pass rm -f "$service/$account" >/dev/null 2>&1 &&
            echo "üóëÔ∏è Deleted secret for '$service'" || echo "‚ùå Secret not found for '$service'"
        ;;
    esac
    ;;

*)
    usage
    ;;
esac
