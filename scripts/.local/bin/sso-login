#!/usr/bin/env bash

if [ "$#" -lt 1 ]; then
    printf "The desired AWS profile(s) must be passed as arguments.\n" >&2
    exit 1
fi

envs=("$@")
VALID_ENVS=(torana-{dev,test,stage,prod,audit,shared,p2dev,p2test} hnb-cp-dev)

for env in "${envs[@]}"; do
    # shellcheck disable=SC2076
    if [[ ! "${VALID_ENVS[*]}" =~ "$env" ]]; then
        echo "Invalid environment passed." >&2
        exit 1
    fi
done

for i in "${envs[@]}"; do
    aws sso login --profile="$i" 2>/dev/null |
    stdbuf -o 0 grep -v "^Attempting\|^If\|^Then\|^$" |
    stdbuf -o 0 sed '2 i ?user_code=' | stdbuf -o 0 tr --delete '\n'
done
